class MsgManager
  FONTS=[
    [
      "＿あいうえおかきくけこさしすせそ",
      "たちつてとなにぬねのはひふへほま",
      "みむめもやゆよらりるれろわをん＝",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づでどばびぶべぼ！‥",
      "言アイウエオカキクケコサシスセソ",
      "タチツテトナニ見ネノハヒフヘホマ",
      "ミムメモヤユヨラリルレロワ名ン？",
      "民ィ内ェ知ャ室ョッガギグゲ会ザジ",
      "時。、‥予想外中嵐航海困難極黒重",
      "潮全身浴豪華客船レディクリサニ＝",
      "号苦痛震１９２３７年月日分午後４",
      "０永久陽目見誌記録大波観測襲小皮",
      "肉期幸福絶頂悪夢転落堪現実人々深",
      "淵恐怖陥心瞬奪去死神本当悲劇幕切",
      "的乗員市場最間＿＿＊＊＊＊＊／＊",
    ].join,
    [
      "＿あいうえおかきくけこさしすせそ",
      "たちつてとなにぬねのはひふへほま",
      "みむめもやゆよらりるれろわをん＝",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づでどばびぶべぼ！‥",
      "言アイウエオカキクケコサシスセソ",
      "タチツテトナニ見ネノハヒフヘホマ",
      "ミムメモヤユヨラリルレロワ名ン？",
      "民ィ内ェ知ャ室ョッガギグゲ会ザジ",
      "ズ主義ダ機関デドバビブベボパピプ",
      "ペ彼１２３＊＊６７＊＊０＃＃＿＿",
      "１２３４５９沖合航海士建築家牧師",
      "医建歳年月日時分ー＃＃＃＃＃＃＃",
      "＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づで＿＊＊＊＊＊／＊",
    ].join,
    [
      "＿あいうえおかきくけこさしすせそ",
      "たちつてとなにぬねのはひふへほま",
      "みむめもやゆよらりるれろわをん＝",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づでどばびぶべぼ！‥",
      "言アイウエオカキクケコサシスセソ",
      "タチツテトナニ見ネノハヒフヘホマ",
      "ミムメモヤユヨラリルレロワ名ン？",
      "民ィ内ェ知ャ室ョッガギグゲ会ザジ",
      "ズ主義ダ機関デドバビブベボパピプ",
      "ペ彼１２３＊＊６７＊＊０＃＃＃＃",
      "＃＃＃＃＃＃ぱぴぷ日ぽーＳュ時間",
      "牧師船話行君戻何海水男女子逃待無",
      "夜年本客今来手医務売店分者人助急",
      "員一二乗事力体大口中教自上下全妹",
      "恩気神正出首先生＿＊＊＊＊＊／＊",
    ].join,
    [
      "＿あいうえおかきくけこさしすせそ",
      "たちつてとなにぬねのはひふへほま",
      "みむめもやゆよらりるれろわをん＝",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づでどばびぶべぼ！‥",
      "言アイウエオカキクケコサシスセソ",
      "タチツテトナニ見ネノハヒフヘホマ",
      "ミムメモヤユヨラリルレロワ名ン？",
      "民ィ内ェ知ャ室ョッガギグゲ会ザジ",
      "ズ主義ダ機関デドバビブベボパピプ",
      "ペ彼１２３＊＊６７＊＊０＃＃＿＿",
      "＿＿＿ゼュィー間、。時１９７４０",
      "年月日分旅客船号沖合荒天遭難津波",
      "受転覆後沈没模様乗員含余名全死亡",
      "海事故史上最大悲劇数生存者発見救",
      "助他以下通豪華午＿＊＊＊＊＊／＊",
    ].join,
    [
      "＿あいうえおかきくけこさしすせそ",
      "たちつてとなにぬねのはひふへほま",
      "みむめもやゆよらりるれろわをん＝",
      "方目ゼぇ前ゃゅょっ長がぎぐげござ",
      "じずぜぞだ社づでどばびぶべぼ！‥",
      "言アイウエオカキクケコサシスセソ",
      "タチツテトナニ人ネノハヒフヘホマ",
      "死中強烈イメージエミ今時時折浅眠",
      "実虚構極限状態私失確取戻笑顔多愛",
      "者流誰ヤワ皆乗子供輝瞳彼心配仕事",
      "神息願祝悲劇影人々狂気勇１９２５",
      "３年月日沖合号上冥福祈敬礼全以来",
      "医者肩書余生人苦難味時代古良終告",
      "世界暗黒坂道楽二思出乾杯一、‥君",
      "何戻ラ医者思神出生ハンブルトロレ",
      "スクリサニア船デ＿＊＊＊＊＊／＊",
    ].join,
  ]
  FONTTAB1=Hash.new{ FONTS[2] }
  FONTTAB2=Hash.new{ FONTS[3] }
  FONTTAB3=Hash.new{|h,i|
    case i
    when 0..15; FONTS[0]
    when 16..30; FONTS[3]
    when 31..73; FONTS[4]
    when 74..78; FONTS[1]
    else; raise IndexError.new("#{i} out of range")
    end
  }
  CAT_INFO={
    "1x"  => { 'bank'=>0x84, 'base'=>0x8000,'idrange'=>0..72,'font'=>FONTTAB3, },
    "2x"  => { 'bank'=>0x87, 'base'=>0x8000,'idrange'=>0..62,'font'=>FONTTAB2, },
    "3x"  => { 'bank'=>0x9b, 'base'=>0x8348,'idrange'=>0..198,'font'=>FONTTAB1, },
    "4x"  => { 'bank'=>0x9c, 'base'=>0x8000,'idrange'=>0..35,'font'=>FONTTAB1, },
    "5y" => { 'bank'=>0x86, 'base'=>0x8000,'idrange'=>0..62,'font'=>FONTTAB1, },
    "5z" => { 'bank'=>0x85, 'base'=>0x8000,'idrange'=>0..24,'font'=>FONTTAB1, },
    "6c" => { 'bank'=>0x8b, 'base'=>0x82d0,'idrange'=>1..133,'font'=>FONTTAB1, },
    "6r" => { 'bank'=>0x8b, 'base'=>0x8afa,'idrange'=>1..123,'font'=>FONTTAB1, },
    "6l" => { 'bank'=>0x8b, 'base'=>0x9283,'idrange'=>1..118,'font'=>FONTTAB1, },
    "6j" => { 'bank'=>0x8b, 'base'=>0x9a05,'idrange'=>1..112,'font'=>FONTTAB1, },
    "7c" => { 'bank'=>0x90, 'base'=>0x8000,'idrange'=>0..2069,'font'=>FONTTAB1, },
    "7r" => { 'bank'=>0x9d, 'base'=>0x8000,'idrange'=>0..2058,'font'=>FONTTAB1, },
    "7l" => { 'bank'=>0x83, 'base'=>0x8000,'idrange'=>0..2180,'font'=>FONTTAB1, },
    "7j" => { 'bank'=>0x88, 'base'=>0x8000,'idrange'=>0..2075,'font'=>FONTTAB1, },
  }
  CATS=CAT_INFO.keys
  def initialize(romobj,cat)
    info=CAT_INFO.fetch(cat)
    @rom=romobj
    @cat=cat
    @bank=info['bank']
    @base=info['base']
    @idrange=info['idrange']
    @font=info['font']
  end
  attr_reader :idrange
  def get(id)
    raise IndexError.new("#{id} out of range") unless idrange===id
    addr=@rom.getword(@bank,@base+id*2)
    rawdata=@rom.getline(@bank,addr)
    fontsel=@font[id]
    msg=rawdata.map{|b| fontsel[b] }.join
    [msg,@bank,addr,rawdata]
  end
end

class ChunkManager
  Chunk=Struct.new(:mid, :mnum, :doans, :ansp, :ansn, :addr){
    #WIP
  }
  BASE=0x8000
  CAT_INFO={
    'p'=>{'compact'=>false, 'msgcat'=>'3x', 'bank'=>0x9b, 'idoff'=>0,    'idmax'=>84},
    'c'=>{'compact'=>true,  'msgcat'=>'7c', 'bank'=>0x9a, 'idoff'=>0,    'idmax'=>522},
    'r'=>{'compact'=>true,  'msgcat'=>'7r', 'bank'=>0x9a, 'idoff'=>522,  'idmax'=>524},
    'l'=>{'compact'=>true,  'msgcat'=>'7l', 'bank'=>0x9a, 'idoff'=>1046, 'idmax'=>539},
    'j'=>{'compact'=>true,  'msgcat'=>'7j', 'bank'=>0x9a, 'idoff'=>1585, 'idmax'=>522},
  }
  CATS=CAT_INFO.keys
  def initialize(rom,cat)
    @rom=rom
    @cat=cat
    info=CAT_INFO.fetch(cat)
    @compact=info['compact']
    @msgcat=info['msgcat']
    @bank=info['bank']
    @idoff=info['idoff']
    @idrange=1..info['idmax']
  end
  attr_reader :msgcat, :idrange, :bank
  def get(cid)
    raise IndexError.new("cid #{cid} out of range for category #{@cat}") unless @idrange===cid
    if @compact
      addr=BASE+(@idoff+cid-1)*5
      bs=@rom.getbytes(@bank,addr,5)
      Chunk.new(
        (((bs[1]&0xf)<<8)|bs[0])+1,
        bs[1]>>4,
        bs[3]>=128,
        ((bs[3]&0x7f)<<4)|(bs[2]>>4),
        ((bs[2]&0xf)<<8)|bs[4],
        addr
      )
    else
      addr=BASE+(@idoff+cid-1)*10
      words=@rom.getwords(@bank,addr,5)
      Chunk.new(
        words[0]+1,
        words[1],
        words[2]!=0,
        words[3],
        words[4],
        addr
      )
    end
  end
end


